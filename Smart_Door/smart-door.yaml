esphome:
  name: smart-door
  # on_boot:
  #   - priority: 600
  #     then: # Power connected = closed, lock after delay
  ##       - delay: !lambda 'return id(servo_duration).state * `0;'
  #       - button.press: door_close

esp32:
  board: nodemcu-32s
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  password: ""

ota:
  - platform: esphome
    password: ""

wifi:
  ssid: "Ab-Apart"
  password: !secret wifi_password
  fast_connect: true

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Smart-Door Fallback Hotspot"
    password: !secret ap_password

captive_portal:
    
# UI Controls
number:
  - platform: template
    id: servo_duration
    name: Servo Rotation Duration
    min_value: 1
    initial_value: 4.5
    max_value: 6
    step: 0.5
    optimistic: true
    web_server:
      sorting_group_id: sorting_group_servo_settings
  - platform: template
    id: servo_number
    name: Servo Control
    min_value: -100
    initial_value: 0
    max_value: 100
    step: 1
    optimistic: true
    web_server:
      sorting_group_id: sorting_group_servo_settings
    set_action:
      then:
        - servo.write:
            id: servo_hw
            level: !lambda 'return x / 100.0;'

button:
  # Most components have REST API, read more: https://esphome.io/web-api/#api-rest
  - platform: template
    name: Open
    id: door_open
    # Equivalent: http://smart-door.local/button/open/press (using name, not id)
    web_server:
      sorting_group_id: sorting_group_door_actions
    on_press:
      # Move servo until the door is opened, or timeout
      - number.set:
          id: servo_number
          value: -100
      - wait_until:
          condition:
            binary_sensor.is_on: door_sensor
          timeout: !lambda 'return id(servo_duration).state * 1000 + 1000;'
      # Continue opening a bit after the door is opened
      - delay: !lambda 'return 3000;'
      - number.set:
          id: servo_number
          value: 0
  - platform: template
    name: Close
    id: door_close
    web_server:
      sorting_group_id: sorting_group_door_actions
    on_press:
      then:
        - number.set:
            id: servo_number
            value: 100
        - delay: !lambda 'return id(servo_duration).state * 1000;'
        - number.set:
            id: servo_number
            value: 0
  - platform: template
    name: Zero
    id: servo_zero
    web_server:
      sorting_group_id: sorting_group_servo_settings
    on_press:
      then:
        - number.set:
            id: servo_number
            value: 0

# Hardwares
binary_sensor:
  # Optional, only when using a battery (always on)
  - platform: gpio
    id: door_sensor
    name: Door Sensor
    device_class: door
    pin:
      number: GPIO12
      mode:
        input: true
        pullup: true
        # Means door is closed on release
    filters:
      - delayed_on_off: 500ms
    on_release:
      then: # Low = closed. Auto-lock when door is closed
        - button.press: door_close
  - platform: gpio
    id: door_button
    name: Door Button
    device_class: door
    pin:
      number: GPIO14
      inverted: true
      mode:
        input: true
        pullup: true
    filters:
      - delayed_on_off: 100ms
    on_press:
      then: # High = pressed. Open the door
        - button.press: door_open

servo:
  - id: servo_hw
    output: servo_pwm_output

output:
  - platform: ledc
    id: servo_pwm_output
    pin: GPIO13
    frequency: 50Hz

web_server:
  version: 3
  port: 80
  sorting_groups:
    - id: sorting_group_door_actions
      name: "Door Actions"
      sorting_weight: 10
    - id: sorting_group_servo_settings
      name: "Servo Settings"
      sorting_weight: 20