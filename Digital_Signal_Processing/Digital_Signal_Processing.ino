#include <Wire.h>
#include <Adafruit_MCP4725.h>

#define ORDER 32

Adafruit_MCP4725 dac;

// Var
float buffer_input[ORDER] = {0};
float buffer_output[ORDER] = {0};
float temp = 0;
int i = 0;
unsigned long time = 0;

// Filter Coefficients (from MATLAB):
float b[ORDER] = {0.00475620121821099,0.00531602775009807,0.00697257638013029,0.00965803223475034,0.0132624559586349,0.0176382846165920,0.0226063729569297,0.0279633277030225,0.0334898346007305,0.0389596373037971,0.0441488004914758,0.0488448779751206,0.0528556104397779,0.0560167967237531,0.0581990163752782,0.0593129282554953,0.0593129282554953,0.0581990163752782,0.0560167967237531,0.0528556104397779,0.0488448779751206,0.0441488004914758,0.0389596373037971,0.0334898346007305,0.0279633277030225,0.0226063729569297,0.0176382846165920,0.0132624559586349,0.00965803223475034,0.00697257638013029,0.00531602775009807,0.00475620121821099};
//float b[ORDER] = {-0.00126123490547738,-0.00184849330106461,-0.00277122455078149,-0.00389561547918654,-0.00474014009013690,-0.00450658595875769,-0.00221711222564580,0.00306513721280641,0.0119792920419832,0.0246356833512128,0.0404716459636847,0.0582391630524604,0.0761407757778390,0.0920959490127426,0.104088464123935,0.110524295974387,0.110524295974387,0.104088464123935,0.0920959490127426,0.0761407757778390,0.0582391630524604,0.0404716459636847,0.0246356833512128,0.0119792920419832,0.00306513721280641,-0.00221711222564580,-0.00450658595875769,-0.00474014009013690,-0.00389561547918654,-0.00277122455078149,-0.00184849330106461,-0.00126123490547738};
//float b[ORDER] = {0.00469507996477189,0.00525788889861302,0.00690879257469375,0.00958574056962078,0.0131835592512375,0.0175582175467350,0.0225327439170178,0.0279045485053358,0.0334538438529784,0.0389528099869197,0.0441751171646823,0.0489054035433550,0.0529483062440749,0.0561366626874889,0.0583385339124463,0.0594627513800291,0.0594627513800291,0.0583385339124463,0.0561366626874889,0.0529483062440749,0.0489054035433550,0.0441751171646823,0.0389528099869197,0.0334538438529784,0.0279045485053358,0.0225327439170178,0.0175582175467350,0.0131835592512375,0.00958574056962078,0.00690879257469375,0.00525788889861302,0.00469507996477189};

void setup() {
    Serial.begin(115200);
    pinMode(5, OUTPUT);
    dac.begin(0x60);
}

void loop() {
    // Shifting data
    for(i = ORDER-1; i > 0; i--) {
        buffer_input[i] = buffer_input[i - 1];
    }

    // Get the new first data, so current input
    buffer_input[0] = analogRead(A2);
    
    // Serial.print(micros()-time);
    // Serial.print(" ");
    // time = micros();
    
    // Calculate the convolution from koefs
    temp = 0;
    for(i = 0; i < ORDER; i++) {
        temp += buffer_input[i] * b[i];
    }
    
    // Output
    buffer_output[0] = temp;
    Serial.print(buffer_input[0]);
    Serial.print(" ");
    Serial.println(buffer_output[0]);

    dac.setVoltage((int)(buffer_output[0]*4), false);
}
